---
import { getUser } from "../utils/firebase/server";
import ThemeChangeButton from "./ThemeChangeButton.astro";

const user = await getUser(Astro.cookies.get("session")?.value);
---

<nav x-data="{ open: false }" class="bg-white dark:bg-gray-800 shadow-md">
  <div class="container mx-auto px-4 py-3 flex justify-between items-center">
    <a href="/" class="text-xl font-bold text-gray-800 dark:text-white"
      >Cuentos de Buenas Noches</a
    >

    <!-- Hamburger Icon -->
    <button @click="open = !open" class="lg:hidden">
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16m-7 6h7"></path></svg
      >
    </button>

    <!-- Menu for larger screens -->
    <div class="hidden lg:flex items-center gap-2">
      <ThemeChangeButton />
      {
        user ? (
          <img
            class="h-8 w-8 cursor-pointer rounded-full border border-zinc-500 object-cover shadow-lg hover:shadow-xl"
            src={user?.photoURL ?? ""}
            alt="user profile"
          />
        ) : (
          <button
            id="google"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2"
          >
            Iniciar Sesión
          </button>
        )
      }
    </div>

    <!-- Dropdown Menu -->
    <div
      x-show="open"
      @click.outside="open = false"
      class="fixed top-0 right-0 w-52 z-10 mt-12 bg-white dark:bg-gray-800 shadow-md rounded-lg"
    >
      <div class="px-4 py-3 flex-row justify-end items-center">
        <button
          class="block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-2"
          >Iniciar Sesión</button
        >
        <ThemeChangeButton />
      </div>
    </div>
  </div>
</nav>
<script>
  import {
    getAuth,
    inMemoryPersistence,
    GoogleAuthProvider,
    signInWithPopup,
  } from "firebase/auth";
  import { app } from "../utils/firebase/client";

  const auth = getAuth(app);
  auth.setPersistence(inMemoryPersistence);

  const googleSignin = document.querySelector("#google") as HTMLButtonElement;

  googleSignin.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    const userCredential = await signInWithPopup(auth, provider);
    const idToken = await userCredential.user.getIdToken();

    const res = await fetch("/api/auth/signin", {
      headers: {
        Authorization: `Bearer ${idToken}`,
      },
    });

    if (res.redirected) {
      window.location.assign(res.url);
    }
  });
</script>
